<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>{{ title or "Echo Line" }}</title>

  <!-- Prevent CSS flash (server cache-busted) -->
  <link rel="preload" as="style" href="/static/css/site.css?v={{ STATIC_VERSION }}" />
  <link rel="stylesheet" href="/static/css/site.css?v={{ STATIC_VERSION }}" />
  <noscript><link rel="stylesheet" href="/static/css/site.css?v={{ STATIC_VERSION }}" /></noscript>

  <style>
    [x-cloak]{display:none !important}

    /* ---------- Theme tokens (defaults) ---------- */
    :root{
      --bg:#0a0f1a;        /* page background */
      --bg-soft:#0f172a;   /* containers/cards */
      --text:#f1f5f9;      /* foreground */
      --muted:#9ca3af;

      --accent-h:174;      /* cyan accent by default */
      --accent-s:100%;
      --accent-l:42%;
    }

    /* Smooth theme transitions */
    html, body, header, main {
      transition: background-color .35s ease, background .35s ease, color .35s ease;
    }

    body{ background:var(--bg); color:var(--text); }

    /* Neon title glow follows accent */
    .neon-title{ position:relative; text-shadow:0 1px 0 rgba(255,255,255,.05) }
    .neon-title::after{
      content:attr(data-text); position:absolute; inset:0;
      color:hsl(var(--accent-h) var(--accent-s) calc(var(--accent-l) + 20%));
      filter:blur(10px) saturate(160%); opacity:.45; pointer-events:none;
    }

    /* Accent wash */
    .theme-base{
      background:
        radial-gradient(1200px 600px at 50% -20%, hsla(var(--accent-h) var(--accent-s) var(--accent-l)/.10), transparent 60%),
        var(--bg-soft);
    }

    /* ---------- Curated palettes (Surge cycles these) ---------- */
    .theme-cyan   { --bg:#07111e; --bg-soft:#0b1525; --accent-h:174; --accent-s:100%; --accent-l:42%; }
    .theme-magenta{ --bg:#140a18; --bg-soft:#1a0f24; --accent-h:316; --accent-s:100%; --accent-l:62%; }
    .theme-amber  { --bg:#151005; --bg-soft:#1e1507; --accent-h:42;  --accent-s:100%; --accent-l:56%; }
    .theme-lime   { --bg:#0d1407; --bg-soft:#111a0a; --accent-h:95;  --accent-s:100%; --accent-l:50%; }
    .theme-violet { --bg:#0f0b1a; --bg-soft:#160f25; --accent-h:262; --accent-s:92%;  --accent-l:58%; }
    .theme-azure  { --bg:#07121a; --bg-soft:#0b1823; --accent-h:204; --accent-s:100%; --accent-l:56%; }

    /* Scanlines overlay (toggle) */
    .scanlines{
      pointer-events:none; position:fixed; inset:0; z-index:30;
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,.10) 0px, rgba(255,255,255,.10) 1px, transparent 1px, transparent 3px);
      mix-blend-mode:overlay; opacity:.35;
    }
    body:not(.has-scanlines) .scanlines{ display:none }

    /* Surge pulse ring (kept) */
    @keyframes surgePulse{
      0%{ box-shadow:0 0 0 0 hsla(var(--accent-h) var(--accent-s) var(--accent-l)/.55) }
      100%{ box-shadow:0 0 0 24px rgba(34,211,238,0) }
    }
    .surge-ring{ animation:surgePulse .6s ease-out }

    /* Desktop safety shim */
    @media (min-width:768px){ .md\:flex{display:flex !important} .md\:hidden{display:none !important} }
  </style>

  <!-- Alpine core -->
  <script defer src="/static/js/alpine.global.min.js"></script>

  <script>
    /* ---------- chapterExtras (unchanged APIs so modals keep working) ---------- */
    window.chapterExtras = function (seed) {
      return {
        openKey: null,
        hasSketches:false, hasNotes:false, hasLore:false, hasAmbient:false, hasReel:false,
        assetsBase: seed?.assetsBase || "",
        state: { created_at:"", ambient_url:"", reel_url:"", sketches:[], notes:{}, lore:{}, _ambientOn:false },

        asset(key){
          if(!key) return "";
          if(/^https?:\/\//i.test(key)) return key;
          const base=(this.assetsBase||"").replace(/\/+$/,"");
          const k=String(key).replace(/^\/+/,"");
          return base ? `${base}/${k}` : `/static/${k}`;
        },

        init(){
          const chapter = seed?.chapter || {};
          let meta = seed?.meta ?? {};
          if (typeof meta === "string"){ try{ meta = JSON.parse(meta) } catch { meta = {} } }
          if (!meta || typeof meta !== "object") meta = {};

          this.state.created_at = chapter.created_at || "";
          this.state.ambient_url = chapter.ambient_url || "";
          this.state.reel_url = chapter.reel_url || "";

          const rawSketches = Array.isArray(meta.sketches) ? meta.sketches : [];
          this.state.sketches = rawSketches
            .map(s => typeof s === "string" ? { src: this.asset(s) } : { ...(s||{}), src: this.asset((s && s.src) || "") })
            .filter(x => !!x.src);

          this.state.notes = (meta.notes && typeof meta.notes === "object") ? meta.notes : {};
          const beatsLen = Array.isArray(this.state.notes?.beats) ? this.state.notes.beats.length : 0;
          const eggsLen  = Array.isArray(this.state.notes?.eggs)  ? this.state.notes.eggs.length  : 0;

          const lore = (meta.lore && typeof meta.lore === "object") ? { ...meta.lore } : {};
          if (lore.portrait) lore.portrait = this.asset(lore.portrait);
          this.state.lore = lore;

          this.hasSketches = this.state.sketches.length > 0;
          this.hasNotes = !!(this.state.notes?.intro || beatsLen || eggsLen);
          this.hasLore =
            !!(this.state.lore?.name || this.state.lore?.bio) ||
            (Array.isArray(this.state.lore?.loadout) && this.state.lore.loadout.length) ||
            (Array.isArray(this.state.lore?.signals) && this.state.lore.signals.length);

          this.hasAmbient = !!this.state.ambient_url;
          this.hasReel = !!this.state.reel_url;

          window.$chapter = this; // console helper
        },

        open(what){ this.openKey = what },
        close(){ this.openKey = null },
      };
    };

    /* ---------- Base UI (Surge cycles full theme) ---------- */
    window.baseUI = function () {
      return {
        theme:'theme-base theme-cyan', // base + one palette
        neonOn:false, scanlinesOn:false,
        lightboxSrc:null, searchOpen:false, mobileOpen:false,

        init(){
          this.neonOn = localStorage.getItem('theme-neon') === '1';
          this.scanlinesOn = localStorage.getItem('scanlines') === '1';
          document.body.classList.toggle('has-scanlines', this.scanlinesOn);

          const saved = localStorage.getItem('theme-palette');
          if (saved) this.theme = `theme-base ${saved}`;

          window.addEventListener('keydown', (e) => {
            if (e.key === 't') this.toggleNeon();
            if (e.key === '/') { e.preventDefault(); this.openSearch(); }
            if (e.key === 'g') this.cycleTheme();
            if (e.key === 's') this.toggleScanlines();
          });
          window.addEventListener('toggle-neon', () => this.toggleNeon());
          window.addEventListener('neon-surge', () => this.cycleTheme());
          window.addEventListener('toggle-scanlines', () => this.toggleScanlines());
          window.addEventListener('open-lightbox', e => { this.lightboxSrc = e.detail || null; });
        },

        toggleNeon(){
          this.neonOn = !this.neonOn;
          localStorage.setItem('theme-neon', this.neonOn ? '1' : '0');
        },

        toggleScanlines(){
          this.scanlinesOn = !this.scanlinesOn;
          document.body.classList.toggle('has-scanlines', this.scanlinesOn);
          localStorage.setItem('scanlines', this.scanlinesOn ? '1' : '0');
        },

        cycleTheme(){
          const el = document.querySelector('main') || document.body;
          el.classList.add('surge-ring'); setTimeout(() => el.classList.remove('surge-ring'), 650);

          const choices = ['theme-cyan','theme-magenta','theme-amber','theme-lime','theme-violet','theme-azure'];
          const current = this.theme.split(' ').find(c => c.startsWith('theme-') && c !== 'theme-base') || 'theme-cyan';
          const pool = choices.filter(c => c !== current);
          const next = pool[Math.floor(Math.random()*pool.length)] || 'theme-magenta';
          this.theme = `theme-base ${next}`;
          localStorage.setItem('theme-palette', next);
        },

        // alias so older templates using @click="surge" don’t break
        surge(){ this.cycleTheme() },

        openSearch(){ this.searchOpen = true; this.$nextTick(() => this.$refs.searchInput?.focus()); },
      };
    };
  </script>
</head>

<body x-data="baseUI()" x-init="init()" :class="theme" class="min-h-screen antialiased">
  <!-- Sticky Top Nav -->
  <header class="sticky top-0 z-40 border-b border-neutral-900/70 bg-neutral-950/80 backdrop-blur supports-[backdrop-filter]:bg-neutral-950/60">
    <nav class="mx-auto max-w-6xl px-4 sm:px-6 h-14 flex items-center justify-between">
      <a href="/" class="shrink-0 font-semibold tracking-tight hover:underline decoration-dotted">Echo Line</a>

      <!-- Desktop links -->
      <div class="hidden md:flex items-center gap-2">
        <a href="/" class="px-3 py-1 rounded hover:bg-neutral-800 transition text-sm">Home</a>
        <a href="/chapters" class="px-3 py-1 rounded hover:bg-neutral-800 transition text-sm">Chapters</a>
        <a href="/about" class="px-3 py-1 rounded hover:bg-neutral-800 transition text-sm">About</a>

        <button @click="toggleNeon"
          class="px-3 py-1 rounded border border-neutral-800 bg-neutral-900/50 hover:bg-neutral-800 transition text-sm">
          <span x-text="neonOn ? 'Neon: ON' : 'Neon: OFF'"></span>
        </button>
        <button @click="toggleScanlines"
          class="px-3 py-1 rounded border border-neutral-800 bg-neutral-900/50 hover:bg-neutral-800 transition text-sm">
          <span x-text="scanlinesOn ? 'Scanlines: ON' : 'Scanlines: OFF'"></span>
        </button>
        <button @click="cycleTheme"
          class="px-3 py-1 rounded border border-neutral-800 bg-neutral-900/50 hover:bg-neutral-800 transition text-sm">
          Surge ⚡
        </button>
        <button @click="openSearch"
          class="px-3 py-1 rounded border border-neutral-800 bg-neutral-900/50 hover:bg-neutral-800 transition text-sm">
          Search <kbd class="ml-1 text-neutral-500">/</kbd>
        </button>
      </div>

      <!-- Mobile menu button -->
      <button @click="mobileOpen=true"
        class="md:hidden inline-flex items-center gap-2 px-3 py-1 rounded border border-neutral-800 bg-neutral-900/50 hover:bg-neutral-800 text-sm">
        Menu
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M3 6h18M3 12h18M3 18h18" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </nav>

    <!-- Mobile drawer -->
    <div x-show="mobileOpen" x-transition.opacity x-cloak @keydown.escape.window="mobileOpen=false"
      class="md:hidden fixed inset-0 z-50 bg-black/70">
      <aside @click.outside="mobileOpen=false"
        class="absolute left-0 top-0 h-full w-[80vw] max-w-sm bg-neutral-950 border-r border-neutral-800 p-4 space-y-3">
        <div class="flex items-center justify-between">
          <span class="font-semibold">Echo Line</span>
          <button @click="mobileOpen=false" class="px-2 py-1 rounded hover:bg-neutral-800">Close</button>
        </div>

        <nav class="mt-2 space-y-1">
          <a href="/" class="block rounded px-3 py-2 hover:bg-neutral-800">Home</a>
          <a href="/chapters" class="block rounded px-3 py-2 hover:bg-neutral-800">Chapters</a>
          <a href="/about" class="block rounded px-3 py-2 hover:bg-neutral-800">About</a>
        </nav>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <button @click="toggleNeon"
            class="rounded border border-neutral-800 bg-neutral-900/60 px-3 py-2 hover:bg-neutral-800 text-sm col-span-2">
            <span x-text="neonOn ? 'Neon: ON' : 'Neon: OFF'"></span>
          </button>
          <button @click="toggleScanlines"
            class="rounded border border-neutral-800 bg-neutral-900/60 px-3 py-2 hover:bg-neutral-800 text-sm col-span-2">
            <span x-text="scanlinesOn ? 'Scanlines: ON' : 'Scanlines: OFF'"></span>
          </button>
          <button @click="cycleTheme"
            class="rounded border border-neutral-800 bg-neutral-900/60 px-3 py-2 hover:bg-neutral-800 text-sm col-span-2">
            Surge ⚡
          </button>
          <button @click="openSearch"
            class="rounded border border-neutral-800 bg-neutral-900/60 px-3 py-2 hover:bg-neutral-800 text-sm col-span-2">
            Search <kbd class="ml-1 text-neutral-500">/</kbd>
          </button>
        </div>
      </aside>
    </div>
  </header>

  <!-- Page -->
  <main class="mx-auto max-w-6xl w-full px-4 sm:px-6 py-6 sm:py-8">
    {% block content %}{% endblock %}
  </main>

  <!-- CRT overlay -->
  <div class="scanlines"></div>

  <!-- Lightbox -->
  <template x-teleport="body">
    <div x-show="lightboxSrc" x-transition.opacity
      class="fixed inset-0 bg-black/80 grid place-items-center p-4 z-50" @click.self="lightboxSrc=null">
      <img :src="lightboxSrc" alt="" class="max-h-full max-w-full rounded-lg shadow-xl" />
      <button @click="lightboxSrc=null"
        class="absolute top-4 right-4 px-3 py-1 rounded bg-neutral-900 border border-neutral-700 hover:bg-neutral-800">Close</button>
    </div>
  </template>

  <!-- Search Modal -->
  <template x-teleport="body">
    <div x-show="searchOpen" x-transition.opacity
      class="fixed inset-0 bg-black/70 z-50 grid place-items-center p-4"
      @keydown.escape.window="searchOpen=false" @click.self="searchOpen=false">
      <div class="w-full max-w-xl rounded-xl border border-neutral-800 bg-neutral-950 p-4">
        <div class="flex items-center gap-2">
          <input x-ref="searchInput" type="search" placeholder="Search (coming soon)…"
            class="w-full bg-neutral-950 border border-neutral-700 rounded px-3 py-2 placeholder-neutral-500 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-600" />
          <button class="px-3 py-2 rounded border border-neutral-700 hover:bg-neutral-800"
            @click="searchOpen=false">Close</button>
        </div>
        <p class="text-xs text-neutral-500 mt-2">Press <kbd>/</kbd> to open • <kbd>Esc</kbd> to close</p>
      </div>
    </div>
  </template>
</body>
</html>