{% extends "base.html" %}
{% block content %}

<!-- iOS modal scrolling helper -->
<style>
  .modal-scroll {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    max-height: 80vh;
  }

  /* Use dynamic viewport on modern mobile for better sizing */
  @supports(height: 1dvh) {
    .modal-scroll {
      max-height: 80dvh;
    }
  }
</style>

<!-- 1) Seed JSON -->
<script id="chapter-seed" type="application/json">
{{ {
  "assetsBase": (ASSETS_BASE or ''),
  "chapter": {
    "title": (chapter.title or ''),
    "created_at": (chapter.created_at.strftime('%B %d, %Y') if chapter.created_at else ''),
    "hero_key": (chapter.hero_key or ''),
    "ambient_url": (chapter.ambient_url or ''),
    "reel_url": (chapter.reel_url or '')
  },
  "meta": (chapter.meta or {})
} | tojson }}
</script>

<!-- 2) Expose seed before Alpine evaluates -->
<script>
  (function () {
    const el = document.getElementById('chapter-seed');
    let seed = {};
    try { seed = JSON.parse(el?.textContent || '{}'); } catch { seed = {}; }
    window.CHAPTER_SEED = seed;
  }());
</script>

<!-- 3) FX seeding via localStorage (no class toggling here; baseUI handles classes) -->
<script>
  (function () {
    const meta = (window.CHAPTER_SEED && window.CHAPTER_SEED.meta) || {};
    const ui = meta.ui || {};
    const q = new URLSearchParams(window.location.search);
    const fxParam = (q.get('fx') || '').toLowerCase();

    let neonOn = localStorage.getItem('theme-neon');
    let scanOn = localStorage.getItem('scanlines');

    if (neonOn === null && ui.hasOwnProperty('neon')) {
      neonOn = ui.neon ? '1' : '0';
      localStorage.setItem('theme-neon', neonOn);
    }
    if (scanOn === null && ui.hasOwnProperty('scanlines')) {
      scanOn = ui.scanlines ? '1' : '0';
      localStorage.setItem('scanlines', scanOn);
    }

    if (fxParam) {
      let neon = (localStorage.getItem('theme-neon') === '1');
      let scan = (localStorage.getItem('scanlines') === '1');
      if (fxParam === 'off' || fxParam === 'none') { neon = false; scan = false; }
      if (fxParam.includes('neon')) neon = true;
      if (fxParam.includes('scan')) scan = true;
      if (fxParam === 'all') { neon = true; scan = true; }
      localStorage.setItem('theme-neon', neon ? '1' : '0');
      localStorage.setItem('scanlines', scan ? '1' : '0');
    }
  })();
</script>

<!-- 4) iOS-safe background scroll lock (preserves modal scrolling) -->
<script>
  (function () {
    let _lockY = 0;
    window.lockScroll = function () {
      if (document.body.dataset.locked === '1') return;
      _lockY = window.scrollY || document.documentElement.scrollTop || 0;
      document.body.dataset.locked = '1';
      document.body.style.position = 'fixed';
      document.body.style.top = `-${_lockY}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';
      document.body.style.width = '100%';
    };
    window.unlockScroll = function () {
      if (document.body.dataset.locked !== '1') return;
      document.body.dataset.locked = '0';
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';
      document.body.style.width = '';
      window.scrollTo({ top: _lockY, behavior: 'instant' });
    };
  })();
</script>

<article x-data="chapterExtras(window.CHAPTER_SEED)" x-init="
    init();
    $watch('openKey', v => { if (v !== null) lockScroll(); else unlockScroll(); });
  " class="mx-auto max-w-5xl px-4 sm:px-6 py-6 space-y-8 relative">

  <!-- Header -->
  <header class="text-center space-y-3">
    <h1 class="neon-title text-3xl sm:text-4xl font-extrabold tracking-tight" data-text="{{ chapter.title }}">
      {{ chapter.title }}
    </h1>

    <template x-if="state.created_at">
      <p class="text-sm text-neutral-400" x-text="`Published ${state.created_at}`"></p>
    </template>

    {% if chapter.hero_key %}
    <img src="{{ asset(chapter.hero_key) }}" alt="{{ chapter.title }}"
      class="mt-4 w-full rounded-xl border border-neutral-800 bg-neutral-900/40 object-cover md:max-h-[560px]"
      loading="eager" decoding="async" />
    {% endif %}
  </header>

  <!-- Reel only -->
  <section x-show="hasReel" x-cloak class="rounded-xl border border-neutral-800 bg-neutral-900/40 p-3 sm:p-4"
    aria-label="Reel">
    <div class="flex flex-col items-center justify-center">
      <a :href="state.reel_url" target="_blank" rel="noopener"
        class="inline-flex h-11 items-center justify-center rounded-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-5 transition">
        Watch the Reel
      </a>
    </div>
  </section>

  <!-- Body -->
  <div class="prose prose-reader prose-invert max-w-none">
    {{ chapter.content | md | safe }}
  </div>

  <hr class="my-8 border-neutral-800" />

  {# ===== Bonus Content cards (server-side rendered, modal-aware) ===== #}
  {% set _meta = chapter.meta or {} %}
  {% set _extras = _meta.get('extras') or {} %}
  {% set _lore = _meta.get('lore') or {} %}
  {% set _sketches = _meta.get('sketches') or [] %}
  {% set _notes = _meta.get('notes') or {} %}

  {% set _has_notes =
  (_notes.get('intro')) or
  (_notes.get('why')) or
  (_notes.get('texture')) or
  (_notes.get('lines') and _notes.get('lines')|length) or
  (_notes.get('beats') and _notes.get('beats')|length) or
  (_notes.get('eggs') and _notes.get('eggs')|length) or
  (_notes.get('music'))
  %}

  {% set _missing_base = request.url_for('extras_missing') %}
  {% set _qs_common = 'chapter_slug=' ~ (chapter.slug or '') ~ '&chapter_title=' ~ (chapter.title|urlencode) %}
  {% set _notes_url = (_extras.get('notes_page') or (_missing_base ~ '?' ~ _qs_common ~ '&kind=notes')) %}
  {% set _lore_url = (_extras.get('lore_page') or (_missing_base ~ '?' ~ _qs_common ~ '&kind=lore')) %}
  {% set _lab_url = (_extras.get('lab_page') or (_missing_base ~ '?' ~ _qs_common ~ '&kind=lab')) %}
  {% set _sketches_url = (_extras.get('sketches_page') or (_missing_base ~ '?' ~ _qs_common ~ '&kind=sketches')) %}

  <section class="space-y-3" aria-label="Bonus content">
    <h2 class="text-lg font-semibold">Bonus Content</h2>
    <ul role="list" class="grid gap-3 sm:grid-cols-2">
      <!-- Director’s Notes card -->
      <li>
        {% if _has_notes %}
        <a href="#" @click.prevent="open('notes')"
          class="block rounded-xl border border-neutral-800 bg-neutral-900/40 hover:bg-neutral-900 transition overflow-hidden">
          <div class="flex items-stretch">
            <div class="hidden sm:block w-36 h-24 shrink-0 border-r border-neutral-800 bg-neutral-950/40"
              style="background-image:url('{{ asset('ui/cards/notes_thumb.jpg') }}');background-size:cover;background-position:center;">
            </div>
            <div class="p-4 min-w-0">
              <div class="text-sm uppercase tracking-widest text-neutral-400">EXTRA</div>
              <div class="font-semibold truncate">Director’s Notes</div>
              <p class="mt-1 text-sm text-neutral-400 line-clamp-2">Commentary, beat map, eggs, and a suggested track.
              </p>
            </div>
          </div>
        </a>
        {% else %}
        <a href="{{ _notes_url }}" target="_blank" rel="noopener"
          class="block rounded-xl border border-neutral-800 bg-neutral-900/40 hover:bg-neutral-900 transition overflow-hidden">
          <div class="flex items-stretch">
            <div class="hidden sm:block w-36 h-24 shrink-0 border-r border-neutral-800 bg-neutral-950/40"
              style="background-image:url('{{ asset('ui/cards/notes_thumb.jpg') }}');background-size:cover;background-position:center;">
            </div>
            <div class="p-4 min-w-0">
              <div class="text-sm uppercase tracking-widest text-neutral-400">EXTRA</div>
              <div class="font-semibold truncate">Director’s Notes</div>
              <p class="mt-1 text-sm text-neutral-400 line-clamp-2">Deep dive commentary, beats, and production
                scribbles.</p>
            </div>
          </div>
        </a>
        {% endif %}
      </li>

      <!-- Lore/Profile card -->
      <li>
        <a href="{{ _lore_url }}" target="_blank" rel="noopener"
          class="block rounded-xl border border-neutral-800 bg-neutral-900/40 hover:bg-neutral-900 transition overflow-hidden">
          <div class="flex items-stretch">
            <div class="hidden sm:block w-36 h-24 shrink-0 border-r border-neutral-800 bg-neutral-950/40" {% if
              _lore.get('portrait') %}
              style="background-image:url('{{ asset(_lore.get('portrait')) }}');background-size:cover;background-position:center;"
              {% endif %}></div>
            <div class="p-4 min-w-0">
              <div class="text-sm uppercase tracking-widest text-neutral-400">LORE</div>
              <div class="font-semibold truncate">
                {{ _lore.get('name') ~ ' — Profile' if _lore.get('name') else 'Character Profile' }}
              </div>
              <p class="mt-1 text-sm text-neutral-400 line-clamp-2">Bio, signals, and hidden threads in the Echo.</p>
            </div>
          </div>
        </a>
      </li>

      <!-- Signal Lab card -->
      <li>
        <a href="{{ _lab_url }}" target="_blank" rel="noopener"
          class="block rounded-xl border border-neutral-800 bg-neutral-900/40 hover:bg-neutral-900 transition overflow-hidden">
          <div class="flex items-stretch">
            <div class="hidden sm:block w-36 h-24 shrink-0 border-r border-neutral-800 bg-neutral-950/40"></div>
            <div class="p-4 min-w-0">
              <div class="text-sm uppercase tracking-widest text-neutral-400">LAB</div>
              <div class="font-semibold truncate">Signal Lab</div>
              <p class="mt-1 text-sm text-neutral-400 line-clamp-2">Process notes, tools, and experiments from the run.
              </p>
            </div>
          </div>
        </a>
      </li>

      <!-- Sketches card -->
      {% set _first = (_sketches[0] if _sketches else '') %}
      {% if _first and _first is string %}
      {% set _thumb = _first %}
      {% elif _first %}
      {% set _thumb = _first.get('src') or '' %}
      {% else %}
      {% set _thumb = '' %}
      {% endif %}
      <li>
        <a href="{{ _sketches_url }}" target="_blank" rel="noopener"
          class="block rounded-xl border border-neutral-800 bg-neutral-900/40 hover:bg-neutral-900 transition overflow-hidden">
          <div class="flex items-stretch">
            <div class="hidden sm:block w-36 h-24 shrink-0 border-r border-neutral-800 bg-neutral-950/40" {% if _thumb
              %} style="background-image:url('{{ asset(_thumb) }}');background-size:cover;background-position:center;"
              {% endif %}></div>
            <div class="p-4 min-w-0">
              <div class="text-sm uppercase tracking-widest text-neutral-400">GALLERY</div>
              <div class="font-semibold truncate">Sketches &amp; Panels</div>
              <p class="mt-1 text-sm text-neutral-400 line-clamp-2">Concepts and production frames from the drop.</p>
            </div>
          </div>
        </a>
      </li>
    </ul>
  </section>

  <!-- ===== Echo Line :: SIGNAL BOOST (Share Console) ===== -->
  <section x-data="shareConsole()" x-init="init()"
    class="relative rounded-xl border border-neutral-800 bg-neutral-950 overflow-hidden" aria-label="Share console">
    <style>
      .sb-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: .75rem
      }

      @media (min-width:640px) {
        .sb-grid {
          grid-template-columns: 1fr auto
        }
      }

      .sb-shell {
        position: relative;
        padding: 1rem
      }

      .sb-shell::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background:
          repeating-linear-gradient(0deg, rgba(34, 211, 238, .10) 0 1px, transparent 1px 3px),
          radial-gradient(900px 500px at 10% -10%, rgba(0, 255, 255, .18), transparent 60%),
          radial-gradient(900px 500px at 90% 110%, rgba(255, 0, 200, .16), transparent 60%);
        mix-blend-mode: screen;
        opacity: .9;
        animation: sbSweep 6s linear infinite;
      }

      @keyframes sbSweep {
        0% {
          background-position: 0 0, 0 0, 0 0
        }

        100% {
          background-position: 0 8px, 30px 0, -30px 0
        }
      }

      .sb-title {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        text-shadow: 0 0 2px #22d3ee, 0 0 8px rgba(34, 211, 238, .55)
      }

      .crt-caret {
        display: inline-block;
        width: .6ch;
        background: #22d3ee;
        box-shadow: 0 0 8px #22d3ee;
        animation: crtCaret 1s steps(2, end) infinite
      }

      @keyframes crtCaret {

        0%,
        100% {
          opacity: 0
        }

        50% {
          opacity: 1
        }
      }

      .sb-btn {
        border: 1px solid #1f2937;
        background: #0b1220;
        padding: .55rem .8rem;
        border-radius: .6rem
      }

      .sb-btn:hover {
        background: #111a2e
      }

      .sb-neon {
        box-shadow: 0 0 0 0 rgba(34, 211, 238, .45);
        transition: box-shadow .25s ease
      }

      .sb-neon:hover {
        box-shadow: 0 0 24px 3px rgba(34, 211, 238, .20)
      }

      .sb-chip {
        font-size: .75rem;
        border: 1px dashed #334155;
        background: #0b1220;
        border-radius: .5rem;
        padding: .25rem .5rem
      }

      .sb-toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: #0b1220;
        border: 1px solid #14532d;
        color: #86efac;
        padding: .5rem .8rem;
        border-radius: .5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .5)
      }

      .sb-grid-b {
        display: grid;
        grid-template-columns: 1fr;
        gap: .5rem
      }

      @media (min-width:480px) {
        .sb-grid-b {
          grid-template-columns: repeat(2, minmax(0, 1fr))
        }
      }

      .sb-glitch {
        position: absolute;
        inset: -2px;
        border-radius: 12px;
        pointer-events: none;
        mix-blend-mode: screen;
        opacity: .9;
        filter: blur(8px);
        background: conic-gradient(from 180deg at 30% 30%, rgba(0, 255, 255, .22), transparent 32%),
          conic-gradient(from 0deg at 70% 70%, rgba(255, 0, 200, .22), transparent 32%),
          radial-gradient(1200px 600px at 50% 0%, rgba(34, 211, 238, .12), transparent 60%);
        animation: sbGlitchRoll 8s ease-in-out infinite;
      }

      @keyframes sbGlitchRoll {

        0%,
        100% {
          transform: rotate(0deg);
          opacity: .85
        }

        50% {
          transform: rotate(1deg);
          opacity: 1
        }
      }
    </style>

    <div class="sb-glitch" aria-hidden="true"></div>

    <div class="sb-shell sb-grid">
      <div class="min-w-0">
        <div class="flex items-center gap-2">
          <span class="sb-chip">terminal://signal-boost</span>
          <span class="sb-chip" x-text="host"></span>
        </div>
        <h2 class="sb-title mt-2 text-base">> broadcast "<span x-text="title"></span>"<span class="crt-caret"></span>
        </h2>

        <div class="mt-3 flex flex-wrap items-center gap-2">
          <code class="text-xs bg-neutral-900 border border-neutral-800 rounded px-2 py-1 select-all break-all"
            x-text="shortUrl" aria-label="Share URL"></code>
          <button @click="copy()" class="sb-btn sb-neon text-sm">Copy Link</button>
          <button @click="sysShare()" class="sb-btn text-sm" x-show="canShare">System Share</button>
        </div>
      </div>

      <div class="self-center">
        <div class="sb-grid-b">
          <a :href="xUrl" target="_blank" rel="noopener" class="sb-btn text-center">Post to X/Twitter</a>
          <a :href="redditUrl" target="_blank" rel="noopener" class="sb-btn text-center">Share on Reddit</a>
          <a :href="mailtoUrl" class="sb-btn text-center">Email a Friend</a>
          <a :href="mastodonUrl" target="_blank" rel="noopener" class="sb-btn text-center">To Mastodon</a>
        </div>
      </div>
    </div>

    <div x-show="toast" x-transition.opacity.duration.200ms class="sb-toast" x-text="toast" @click="toast=''"
      role="status" aria-live="polite"></div>

    <script>
      function shareConsole() {
        return {
          title: "{{ chapter.title|replace('"','\\"') }}",
          url: "", shortUrl: "", host: "", canShare: false, toast: "",
          xUrl: "#", redditUrl: "#", mailtoUrl: "#", mastodonUrl: "#",
          utm(u) { try { const url = new URL(u); url.searchParams.set("utm_source", "share"); url.searchParams.set("utm_medium", "reader"); url.searchParams.set("utm_campaign", "echo-line"); return url.toString(); } catch { return u } },
          init() {
            const loc = window.location;
            this.url = this.utm(loc.href);
            this.shortUrl = this.url.replace(/^https?:\/\//, '');
            this.host = loc.host;
            const text = encodeURIComponent(`${this.title} — Echo Line`);
            const link = encodeURIComponent(this.url);
            this.xUrl = `https://twitter.com/intent/tweet?text=${text}&url=${link}`;
            this.redditUrl = `https://www.reddit.com/submit?title=${text}&url=${link}`;
            this.mailtoUrl = `mailto:?subject=${text}&body=${link}`;
            this.mastodonUrl = `https://mastodonshare.com/?text=${text}%20${link}`;
            this.canShare = !!navigator.share;
          },
          async copy() { try { await navigator.clipboard.writeText(this.url); this.toast = 'Copied link to clipboard.'; setTimeout(() => this.toast = '', 1800); } catch { this.toast = 'Copy failed. Long-press the link to select.'; setTimeout(() => this.toast = '', 2200); } },
          async sysShare() { if (!navigator.share) return; try { await navigator.share({ title: this.title, url: this.url, text: `${this.title} — Echo Line` }); } catch { } }
        }
      }
    </script>
  </section>
  <!-- ===== /Signal Boost ===== -->

  <!-- NAV -->
  <nav class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3"
    aria-label="Chapter navigation">
    {% if prev %}
    <a href="/chapters/{{ prev.slug }}"
      class="group inline-flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900/50 px-4 py-2 hover:bg-neutral-800 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition -translate-x-0.5 group-hover:-translate-x-1"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path d="M15 18l-6-6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <span class="text-sm">
        <span class="block text-neutral-400">Previous</span>
        <span class="block font-medium text-white truncate max-w-[16rem]">{{ prev.title }}</span>
      </span>
    </a>
    {% else %}
    <span
      class="inline-flex items-center gap-2 rounded-lg border border-neutral-900 bg-neutral-950/50 px-4 py-2 text-neutral-600 cursor-default select-none">
      Previous
    </span>
    {% endif %}

    <a href="/chapters"
      class="inline-flex items-center justify-center rounded-lg border border-neutral-800 bg-neutral-900/50 px-4 py-2 hover:bg-neutral-800 transition text-sm">
      All Chapters
    </a>

    {% if next %}
    <a href="/chapters/{{ next.slug }}"
      class="group inline-flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900/50 px-4 py-2 hover:bg-neutral-800 transition">
      <span class="text-sm text-right">
        <span class="block text-neutral-400">Next</span>
        <span class="block font-medium text-white truncate max-w-[16rem]">{{ next.title }}</span>
      </span>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition translate-x-0.5 group-hover:translate-x-1"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path d="M9 6l6 6-6 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    </a>
    {% else %}
    <span
      class="inline-flex items-center gap-2 rounded-lg border border-neutral-900 bg-neutral-950/50 px-4 py-2 text-neutral-600 cursor-default select-none">
      Next
    </span>
    {% endif %}
  </nav>

  <!-- === MODALS === -->

  <!-- Backdrop -->
  <div x-show="openKey !== null" x-transition.opacity x-cloak class="fixed inset-0 z-[9998] bg-black/70"
    @click.self="close()" @keydown.escape.window="close()"></div>

  <!-- SKETCHES -->
  <div x-show="openKey==='sketches'" x-cloak
    class="fixed inset-x-0 top-[8vh] z-[9999] mx-auto w-[92vw] max-w-5xl rounded-xl border border-neutral-800 bg-neutral-950 shadow-xl"
    role="dialog" aria-modal="true" aria-label="Sketches modal">
    <div class="modal-scroll p-4 sm:p-6" style="max-height:84vh">
      <header class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Sketches &amp; Panels</h3>
        <button @click="close()" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800">Close</button>
      </header>

      <ul role="list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
        <template x-for="(img, idx) in (state.sketches || [])" :key="img?.src || idx">
          <li>
            <button @click="$dispatch('open-lightbox', img?.src || '')"
              class="block w-full aspect-[4/3] overflow-hidden rounded-lg border border-neutral-800 bg-neutral-900/40 hover:bg-neutral-900"
              :disabled="!img?.src">
              <img :src="img?.src || ''" :alt="img?.alt || 'Sketch'" class="w-full h-full object-cover" loading="lazy"
                decoding="async">
            </button>
            <p class="mt-1 text-xs text-neutral-400" x-text="img?.caption || ''"></p>
          </li>
        </template>

        <li x-show="!(state.sketches && state.sketches.length)" class="col-span-full text-sm text-neutral-400">
          No sketches yet.
        </li>
      </ul>
    </div>
  </div>

  <!-- NOTES -->
  <div x-show="openKey==='notes'" x-cloak
    class="fixed inset-x-0 top-[10vh] z-[9999] mx-auto w-[92vw] max-w-3xl rounded-xl border border-neutral-800 bg-neutral-950 shadow-xl"
    role="dialog" aria-modal="true" aria-label="Notes modal">
    <div class="modal-scroll p-4 sm:p-6" style="max-height:80vh">
      <header class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Author Notes</h3>
        <button @click="close()" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800">Close</button>
      </header>

      <div class="prose prose-invert max-w-none text-sm leading-relaxed">
        <p x-text="state.notes?.intro || ''"></p>

        <div x-show="(state.notes?.beats || []).length">
          <hr class="my-4 border-neutral-800" />
          <h4 class="text-base font-semibold">Beat Map</h4>
          <ol class="list-decimal pl-5 space-y-1">
            <template x-for="(b, i) in (state.notes?.beats || [])" :key="i">
              <li x-text="b"></li>
            </template>
          </ol>
        </div>

        <div x-show="(state.notes?.eggs || []).length">
          <hr class="my-4 border-neutral-800" />
          <h4 class="text-base font-semibold">Easter Eggs</h4>
          <ul class="list-disc pl-5 space-y-1">
            <template x-for="(e, i) in (state.notes?.eggs || [])" :key="i">
              <li x-text="e"></li>
            </template>
          </ul>
        </div>

        <div x-show="state.notes?.music" class="mt-4">
          <hr class="my-4 border-neutral-800" />
          <h4 class="text-base font-semibold">Suggested Track</h4>
          <p class="text-sm text-neutral-400">
            <a :href="state.notes.music" target="_blank" rel="noopener"
              class="text-cyan-400 hover:text-cyan-300 underline">
              Listen on YouTube
            </a>
          </p>
        </div>

        <p x-show="!(state.notes?.intro) && !(state.notes?.beats?.length) && !(state.notes?.eggs?.length) && !(state.notes?.music)"
          class="text-neutral-400">No notes yet.</p>
      </div>
    </div>
  </div>

  <!-- LORE -->
  <div x-show="openKey==='lore'" x-cloak
    class="fixed inset-x-0 top-[12vh] z-[9999] mx-auto w-[92vw] max-w-3xl rounded-xl border border-neutral-800 bg-neutral-950 shadow-xl"
    role="dialog" aria-modal="true" aria-label="Lore modal">
    <div class="modal-scroll p-4 sm:p-6" style="max-height:78vh">
      <header class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Character Lore</h3>
        <button @click="close()" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800">Close</button>
      </header>

      <div class="space-y-4">
        <div class="rounded-lg border border-neutral-800 bg-neutral-900/40 p-4">
          <div class="flex items-start gap-3">
            <img :src="state.lore?.portrait || ''" alt=""
              class="w-16 h-16 rounded object-cover border border-neutral-800" x-show="!!(state.lore?.portrait)">
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-widest text-neutral-400" x-text="state.lore?.tag || ''"></div>
              <h4 class="font-semibold" x-text="state.lore?.name || ''"></h4>
              <p class="text-sm text-neutral-300 mt-1" x-text="state.lore?.bio || ''"></p>
            </div>
          </div>

          <div x-show="window.CHAPTER_SEED?.meta?.extras?.lore_page" class="mt-3">
            <a :href="window.CHAPTER_SEED.meta.extras.lore_page" target="_blank" rel="noopener"
              class="inline-flex h-10 items-center justify-center rounded-full border border-neutral-700 bg-neutral-900/60 hover:bg-neutral-800 px-4 text-sm">
              Open full character page
            </a>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <div class="rounded-lg border border-neutral-800 p-3">
            <h5 class="text-sm font-semibold mb-2">Loadout</h5>
            <ul class="text-sm list-disc pl-5 space-y-1">
              <template x-for="(t, i) in (state.lore?.loadout || [])" :key="i">
                <li x-text="t"></li>
              </template>
            </ul>
            <p x-show="!(state.lore?.loadout?.length)" class="text-sm text-neutral-400">—</p>
          </div>
          <div class="rounded-lg border border-neutral-800 p-3">
            <h5 class="text-sm font-semibold mb-2">Signals</h5>
            <ul class="text-sm list-disc pl-5 space-y-1">
              <template x-for="(s, i) in (state.lore?.signals || [])" :key="i">
                <li x-text="s"></li>
              </template>
            </ul>
            <p x-show="!(state.lore?.signals?.length)" class="text-sm text-neutral-400">—</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const uid = {{ (request.session.get('user_id') is not none)| tojson
    }};
    const cid = {{ chapter.id }};
    if (!uid || !cid) return;

    let fired = false;
    function send() {
      if (fired) return; fired = true;
      fetch('/t/read?chapter_id=' + cid, { method: 'POST', headers: { 'X-Requested-With': 'fetch' } });
    }
    setTimeout(send, 15000);
    window.addEventListener('scroll', () => {
      const y = window.scrollY, h = document.documentElement.scrollHeight - innerHeight;
      if (h > 0 && y / h > 0.4) send();
    }, { passive: true });
    }) ();
  </script>

</article>
{% endblock %}