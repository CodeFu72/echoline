{% extends "base.html" %}
{% block content %}

<!-- 1) Seed JSON -->
<script id="chapter-seed" type="application/json">
{{ {
  "assetsBase": (ASSETS_BASE or ''),
  "chapter": {
    "title": (chapter.title or ''),
    "created_at": (chapter.created_at.strftime('%B %d, %Y') if chapter.created_at else ''),
    "hero_key": (chapter.hero_key or ''),
    "ambient_url": (chapter.ambient_url or ''),
    "reel_url": (chapter.reel_url or '')
  },
  "meta": (chapter.meta or {})
} | tojson }}
</script>

<!-- 2) Expose seed before Alpine evaluates -->
<script>
  (function () {
    const el = document.getElementById('chapter-seed');
    let seed = {};
    try { seed = JSON.parse(el?.textContent || '{}'); } catch { seed = {}; }
    window.CHAPTER_SEED = seed;
  }());
</script>

<article x-data="chapterExtras(window.CHAPTER_SEED)" x-init="init()"
         class="mx-auto max-w-5xl px-4 sm:px-6 py-6 space-y-8">

  <!-- Header -->
  <header class="text-center space-y-3">
    <h1 class="neon-title text-3xl sm:text-4xl font-extrabold tracking-tight" data-text="{{ chapter.title }}">
      {{ chapter.title }}
    </h1>

    <template x-if="state.created_at">
      <p class="text-sm text-neutral-400" x-text="`Published ${state.created_at}`"></p>
    </template>

    {% if chapter.hero_key %}
    <img src="{{ asset(chapter.hero_key) }}" alt="{{ chapter.title }}"
         class="mt-4 w-full rounded-xl border border-neutral-800 bg-neutral-900/40 object-cover md:max-h-[560px]"
         loading="eager" decoding="async" />
    {% endif %}
  </header>

  <!-- Ambient / Reel -->
  <section x-show="hasAmbient || hasReel" x-cloak
           class="rounded-xl border border-neutral-800 bg-neutral-900/40 p-3 sm:p-4">
    <div class="flex flex-col gap-3">
      <template x-if="hasAmbient">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm text-neutral-400">Ambient</div>
          <div class="flex items-center gap-2">
            <button x-show="!state._ambientOn" @click="state._ambientOn = true"
              class="inline-flex h-9 items-center justify-center rounded-full bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 px-3 text-sm">
              Enable ambient
            </button>
            <button x-show="state._ambientOn" @click="state._ambientOn = false"
              class="inline-flex h-9 items-center justify-center rounded-full bg-neutral-900 hover:bg-neutral-800 border border-neutral-700 px-3 text-sm">
              Disable
            </button>
          </div>
        </div>
      </template>

      <div x-show="state._ambientOn" x-transition x-cloak
           class="w-full aspect-video rounded-lg overflow-hidden border border-neutral-800 bg-black">
        <iframe
          :src="`${state.ambient_url}${state.ambient_url.includes('?') ? '&' : '?'}controls=0&modestbranding=1&rel=0&playsinline=1&iv_load_policy=3`"
          title="Ambient" allow="autoplay; encrypted-media; picture-in-picture"
          referrerpolicy="strict-origin-when-cross-origin" allowfullscreen loading="lazy"
          class="w-full h-full"></iframe>
      </div>

      <template x-if="hasReel">
        <div class="flex items-center justify-center">
          <a :href="state.reel_url" target="_blank" rel="noopener"
             class="inline-flex h-11 items-center justify-center rounded-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-5 transition">
            Watch the Reel
          </a>
        </div>
      </template>
    </div>
  </section>

  <!-- Body -->
  <div class="prose prose-reader prose-invert max-w-none">
    {{ chapter.content | md | safe }}
  </div>

  <hr class="my-8 border-neutral-800" />

  <!-- ===== Bonus Content cards (SAFE: separate Alpine component) ===== -->
  <section
    x-data="(() => {
      const seed = window.CHAPTER_SEED || {};
      const ex = (seed.meta && seed.meta.extras) || {};
      const assetsBase = (seed.assetsBase || '').replace(/\/+$/, '');
      const asset = (k) => {
        if (!k) return '';
        if (/^https?:\/\//i.test(k)) return k;
        const key = String(k).replace(/^\/+/, '');
        return assetsBase ? `${assetsBase}/${key}` : `/static/${key}`;
      };
      const cards = [];
      if (ex.notes_page) {
        cards.push({
          href: ex.notes_page,
          kicker: 'EXTRA',
          title: 'Director’s Notes',
          desc: 'Deep dive commentary, beats, and production scribbles.',
          thumb: asset('ui/cards/notes_thumb.jpg')
        });
      }
      if (ex.lore_page) {
        const lore = (seed.meta && seed.meta.lore) || {};
        cards.push({
          href: ex.lore_page,
          kicker: 'LORE',
          title: lore.name ? `${lore.name} — Profile` : 'Character Profile',
          desc: 'Bio, signals, and hidden threads in the Echo.',
          thumb: lore.portrait ? asset(lore.portrait) : ''
        });
      }
      if (ex.sketches_page) {
        const sk = Array.isArray(seed.meta && seed.meta.sketches) ? seed.meta.sketches : [];
        let first = '';
        if (sk.length) {
          const s0 = typeof sk[0] === 'string' ? sk[0] : (sk[0] && sk[0].src) || '';
          first = asset(s0);
        }
        cards.push({
          href: ex.sketches_page,
          kicker: 'GALLERY',
          title: 'Sketches & Panels',
          desc: 'Concepts and production frames from the drop.',
          thumb: first
        });
      }
      return { cards };
    })()"
    x-show="cards.length"
    x-cloak
    class="space-y-3"
  >
    <h2 class="text-lg font-semibold">Bonus Content</h2>
    <ul role="list" class="grid gap-3 sm:grid-cols-2">
      <template x-for="card in cards" :key="card.href">
        <li>
          <a :href="card.href" target="_blank" rel="noopener"
             class="block rounded-xl border border-neutral-800 bg-neutral-900/40 hover:bg-neutral-900 transition overflow-hidden">
            <div class="flex items-stretch">
              <div class="hidden sm:block w-36 h-24 shrink-0 border-r border-neutral-800 bg-neutral-950/40">
                <img :src="card.thumb || ''" alt="" class="w-full h-full object-cover" x-show="!!card.thumb">
              </div>
              <div class="p-4 min-w-0">
                <div class="text-sm uppercase tracking-widest text-neutral-400" x-text="card.kicker"></div>
                <div class="font-semibold truncate" x-text="card.title"></div>
                <p class="mt-1 text-sm text-neutral-400 line-clamp-2" x-text="card.desc"></p>
              </div>
            </div>
          </a>
        </li>
      </template>
    </ul>
  </section>

  <!-- ===== Inline EXTRAS (unchanged) ===== -->
  <section aria-label="Extras" class="rounded-xl border border-neutral-800 bg-neutral-900/40 p-4">
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3">
      <h2 class="text-lg font-semibold">Extras</h2>

      <div class="flex flex-wrap items-center gap-2">
        <template x-if="hasSketches">
          <button @click="open('sketches')"
                  class="inline-flex h-11 items-center justify-center rounded-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-5 transition">
            View Sketches
          </button>
        </template>

        <template x-if="hasNotes">
          <button @click="open('notes')"
                  class="inline-flex h-11 items-center justify-center rounded-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-5 transition">
            Read Notes
          </button>
        </template>

        <template x-if="hasLore">
          <button @click="open('lore')"
                  class="inline-flex h-11 items-center justify-center rounded-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-5 transition">
            Character Lore
          </button>
        </template>

        <template x-if="!hasSketches && !hasNotes && !hasLore">
          <span class="text-sm text-neutral-400">Bonus content coming soon.</span>
        </template>
      </div>
    </div>
  </section>

  <!-- NAV -->
  <nav class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3"
       aria-label="Chapter navigation">
    {% if prev %}
    <a href="/chapters/{{ prev.slug }}"
       class="group inline-flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900/50 px-4 py-2 hover:bg-neutral-800 transition">
      <svg xmlns="http://www.w3.org/2000/svg"
           class="h-4 w-4 transition -translate-x-0.5 group-hover:-translate-x-1" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" aria-hidden="true">
        <path d="M15 18l-6-6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <span class="text-sm">
        <span class="block text-neutral-400">Previous</span>
        <span class="block font-medium text-white truncate max-w-[16rem]">{{ prev.title }}</span>
      </span>
    </a>
    {% else %}
    <span class="inline-flex items-center gap-2 rounded-lg border border-neutral-900 bg-neutral-950/50 px-4 py-2 text-neutral-600 cursor-default select-none">
      Previous
    </span>
    {% endif %}

    <a href="/chapters"
       class="inline-flex items-center justify-center rounded-lg border border-neutral-800 bg-neutral-900/50 px-4 py-2 hover:bg-neutral-800 transition text-sm">
      All Chapters
    </a>

    {% if next %}
    <a href="/chapters/{{ next.slug }}"
       class="group inline-flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900/50 px-4 py-2 hover:bg-neutral-800 transition">
      <span class="text-sm text-right">
        <span class="block text-neutral-400">Next</span>
        <span class="block font-medium text-white truncate max-w-[16rem]">{{ next.title }}</span>
      </span>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition translate-x-0.5 group-hover:translate-x-1"
           viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path d="M9 6l6 6-6 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    </a>
    {% else %}
    <span class="inline-flex items-center gap-2 rounded-lg border border-neutral-900 bg-neutral-950/50 px-4 py-2 text-neutral-600 cursor-default select-none">
      Next
    </span>
    {% endif %}
  </nav>

  <!-- === MODALS (inline; no teleport) === -->

  <!-- Backdrop -->
  <div x-show="openKey !== null" x-transition.opacity x-cloak
       class="fixed inset-0 z-[9998] bg-black/70"
       @click.self="close()" @keydown.escape.window="close()"></div>

  <!-- SKETCHES -->
  <div :class="openKey==='sketches' ? '' : 'hidden'"
       class="fixed inset-x-0 top-[8vh] z-[9999] mx-auto w-[92vw] max-w-5xl rounded-xl border border-neutral-800 bg-neutral-950 p-4 sm:p-6 shadow-xl">
    <header class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Sketches &amp; Panels</h3>
      <button @click="close()" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800">Close</button>
    </header>

    <ul role="list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
      <template x-for="(img, idx) in (state.sketches || [])" :key="img?.src || idx">
        <li>
          <button @click="$dispatch('open-lightbox', img?.src || '')"
                  class="block w-full aspect-[4/3] overflow-hidden rounded-lg border border-neutral-800 bg-neutral-900/40 hover:bg-neutral-900"
                  :disabled="!img?.src">
            <img :src="img?.src || ''" :alt="img?.alt || 'Sketch'" class="w-full h-full object-cover" loading="lazy" decoding="async">
          </button>
          <p class="mt-1 text-xs text-neutral-400" x-text="img?.caption || ''"></p>
        </li>
      </template>

      <li x-show="!(state.sketches && state.sketches.length)" class="col-span-full text-sm text-neutral-400">
        No sketches yet.
      </li>
    </ul>
  </div>

  <!-- NOTES -->
  <div :class="openKey==='notes' ? '' : 'hidden'"
       class="fixed inset-x-0 top-[10vh] z-[9999] mx-auto w-[92vw] max-w-3xl rounded-xl border border-neutral-800 bg-neutral-950 p-4 sm:p-6 shadow-xl">
    <header class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Author Notes</h3>
      <button @click="close()" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800">Close</button>
    </header>

    <div class="prose prose-invert max-w-none text-sm leading-relaxed">
      <p x-text="state.notes?.intro || ''"></p>

      <div x-show="(state.notes?.beats || []).length">
        <hr class="my-4 border-neutral-800" />
        <h4 class="text-base font-semibold">Beat Map</h4>
        <ol class="list-decimal pl-5 space-y-1">
          <template x-for="(b, i) in (state.notes?.beats || [])" :key="i">
            <li x-text="b"></li>
          </template>
        </ol>
      </div>

      <div x-show="(state.notes?.eggs || []).length">
        <hr class="my-4 border-neutral-800" />
        <h4 class="text-base font-semibold">Easter Eggs</h4>
        <ul class="list-disc pl-5 space-y-1">
          <template x-for="(e, i) in (state.notes?.eggs || [])" :key="i">
            <li x-text="e"></li>
          </template>
        </ul>
      </div>

      <p x-show="!(state.notes?.intro) && !(state.notes?.beats?.length) && !(state.notes?.eggs?.length)"
         class="text-neutral-400">No notes yet.</p>
    </div>
  </div>

  <!-- LORE -->
  <div :class="openKey==='lore' ? '' : 'hidden'"
       class="fixed inset-x-0 top-[12vh] z-[9999] mx-auto w-[92vw] max-w-3xl rounded-xl border border-neutral-800 bg-neutral-950 p-4 sm:p-6 shadow-xl">
    <header class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Character Lore</h3>
      <button @click="close()" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800">Close</button>
    </header>

    <div class="space-y-4">
      <div class="rounded-lg border border-neutral-800 bg-neutral-900/40 p-4">
        <div class="flex items-start gap-3">
          <img :src="state.lore?.portrait || ''" alt=""
               class="w-16 h-16 rounded object-cover border border-neutral-800"
               x-show="!!(state.lore?.portrait)">
          <div class="min-w-0">
            <div class="text-xs uppercase tracking-widest text-neutral-400" x-text="state.lore?.tag || ''"></div>
            <h4 class="font-semibold" x-text="state.lore?.name || ''"></h4>
            <p class="text-sm text-neutral-300 mt-1" x-text="state.lore?.bio || ''"></p>
          </div>
        </div>

        <!-- Safe CTA: link out to standalone lore page if present -->
        <div x-show="window.CHAPTER_SEED?.meta?.extras?.lore_page" class="mt-3">
          <a :href="window.CHAPTER_SEED.meta.extras.lore_page" target="_blank" rel="noopener"
             class="inline-flex h-10 items-center justify-center rounded-full border border-neutral-700 bg-neutral-900/60 hover:bg-neutral-800 px-4 text-sm">
            Open full character page
          </a>
        </div>
      </div>

      <div class="grid sm:grid-cols-2 gap-3">
        <div class="rounded-lg border border-neutral-800 p-3">
          <h5 class="text-sm font-semibold mb-2">Loadout</h5>
          <ul class="text-sm list-disc pl-5 space-y-1">
            <template x-for="(t, i) in (state.lore?.loadout || [])" :key="i">
              <li x-text="t"></li>
            </template>
          </ul>
          <p x-show="!(state.lore?.loadout?.length)" class="text-sm text-neutral-400">—</p>
        </div>
        <div class="rounded-lg border border-neutral-800 p-3">
          <h5 class="text-sm font-semibold mb-2">Signals</h5>
          <ul class="text-sm list-disc pl-5 space-y-1">
            <template x-for="(s, i) in (state.lore?.signals || [])" :key="i">
              <li x-text="s"></li>
            </template>
          </ul>
          <p x-show="!(state.lore?.signals?.length)" class="text-sm text-neutral-400">—</p>
        </div>
      </div>
    </div>
  </div>

</article>
{% endblock %}